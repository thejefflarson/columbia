<html>
  <head>
    <title>Class Three | Intro to GIS</title>
    <link rel="stylesheet" href="../stylesheets/reset.css">
    <link rel="stylesheet" href="../stylesheets/tachyons.min.css">
    <link rel="stylesheet" href="../stylesheets/tweaks.css">
    <script src="../javascripts/d3.js"></script>
    <script src="../javascripts/topojson.min.js"></script>
    <script src="../javascripts/wicket.js"></script>
    <style>
     path {
       fill: none;
       stroke: #666;
       stroke-linejoin: round;
       stroke-width: 2px;
     }
    </style>
  </head>
  <body class="sans-serif center fl pa5 dark-gray f5 lh-copy w-100">
    <h2 class="fw8 f3 pv4 ttu lh-title silver tracked">Last Week's homework</h2>
    <p class="pv2 measure-wide">
      In order to receive a grade for last week's homework please choose
      <b class="b">Project > Save as Image</b> in QGIS. Email that image to
      me, at <a href="mailto:jal2301@columbia.edu">jal2301@columbia.edu</a>.
    </p>
    <h2 class="fw8 f3 pv4 ttu lh-title silver tracked">Reading and Writing Shapefiles in Python</h2>
    <p class="pv2 measure-wide">
      We're going to use the <a href="">Fiona</a> package that provides a nice
      interface to <a href="http://gdal.org/1.11/ogr/">OGR</a>.
    </p>
    <p class="pb2 measure-wide">
      Here's a replacement for <tt>ogrinfo</tt>:
    </p>
    <pre id="read.py" class="code overflow-scroll bg-near-white pa2 pre">
import fiona
import sys

with fiona.drivers():
    with fiona.open(sys.argv[1]) as source:
        print(source.crs)
        print(source.driver)
        print(source.schema)
        for shape in source:
            print(shape)</pre>
    <p class="pb2 measure-wide">
      And here's how to copy one shapefile to another:
    </p>
    <pre id="copy.py" class="code overflow-scroll bg-near-white pa2 pre">
import fiona
import sys

with fiona.drivers():
    with fiona.open(sys.argv[1]) as source:
        with fiona.open(sys.argv[2],
                        'w',
                        driver=source.driver,
                        crs=source.crs,
                        schema=source.schema) as dest:
            dest.writerecords(source)</pre>
    <h2 class="fw8 f3 pv4 ttu lh-title silver tracked">Spatial Operations</h2>
    <h3 class="fw5 f4">Buffer</h3>
    <div id="buffer"></div>
    <pre class="code overflow-scroll bg-near-white pa2 pre">
>>> from shapely.wkt import loads, dumps
>>> dumps(loads('POINT (0 0)').buffer(10))
'POLYGON ((10.0000000000000000 0.0000000000000000, 9.9518472667219697 -0.9801714032956050, 9.8078528040323043 -1.9509032201612808, 9.5694033573220896 -2.9028467725446210, 9.2387953251128696 -3.8268343236508939, 8.8192126434835529 -4.7139673682599721, 8.3146961230254561 -5.5557023301960173, 7.7301045336273742 -6.3439328416364491, 7.0710678118654808 -7.0710678118654702, 6.3439328416364624 -7.7301045336273635, 5.5557023301960315 -8.3146961230254472, 4.7139673682599863 -8.8192126434835458, 3.8268343236509086 -9.2387953251128625, 2.9028467725446356 -9.5694033573220842, 1.9509032201612964 -9.8078528040323025, 0.9801714032956209 -9.9518472667219662, 0.0000000000000162 -10.0000000000000000, -0.9801714032955888 -9.9518472667219697, -1.9509032201612646 -9.8078528040323079, -2.9028467725446050 -9.5694033573220949, -3.8268343236508784 -9.2387953251128749, -4.7139673682599570 -8.8192126434835600, -5.5557023301960040 -8.3146961230254650, -6.3439328416364393 -7.7301045336273821, -7.0710678118654613 -7.0710678118654888, -7.7301045336273582 -6.3439328416364678, -8.3146961230254437 -5.5557023301960360, -8.8192126434835423 -4.7139673682599899, -9.2387953251128625 -3.8268343236509113, -9.5694033573220842 -2.9028467725446361, -9.8078528040323025 -1.9509032201612948, -9.9518472667219680 -0.9801714032956171, -10.0000000000000000 -0.0000000000000101, -9.9518472667219697 0.9801714032955970, -9.8078528040323061 1.9509032201612750, -9.5694033573220914 2.9028467725446170, -9.2387953251128696 3.8268343236508922, -8.8192126434835529 4.7139673682599721, -8.3146961230254544 5.5557023301960200, -7.7301045336273706 6.3439328416364527, -7.0710678118654773 7.0710678118654746, -6.3439328416364589 7.7301045336273670, -5.5557023301960298 8.3146961230254472, -4.7139673682599863 8.8192126434835458, -3.8268343236509117 9.2387953251128625, -2.9028467725446410 9.5694033573220842, -1.9509032201613041 9.8078528040323008, -0.9801714032956310 9.9518472667219662, -0.0000000000000285 10.0000000000000000, 0.9801714032955744 9.9518472667219715, 1.9509032201612482 9.8078528040323114, 2.9028467725445868 9.5694033573220985, 3.8268343236508588 9.2387953251128838, 4.7139673682599366 8.8192126434835707, 5.5557023301959818 8.3146961230254810, 6.3439328416364145 7.7301045336274026, 7.0710678118654355 7.0710678118655146, 7.7301045336273324 6.3439328416365006, 8.3146961230254171 5.5557023301960742, 8.8192126434835192 4.7139673682600343, 9.2387953251128412 3.8268343236509610, 9.5694033573220683 2.9028467725446925, 9.8078528040322901 1.9509032201613570, 9.9518472667219608 0.9801714032956848, 10.0000000000000000 0.0000000000000824, 10.0000000000000000 0.0000000000000000))'</pre>

    <h3 class="fw5 f4">Simplify</h3>
    <div id="simplify"></div>
    <pre class="code overflow-scroll bg-near-white pa2 pre">
>>> from shapely.wkt import loads, dumps
>>> dumps(loads('POINT (0 0)').buffer(10).simplify(0.1))
'POLYGON ((10.0000000000000000 0.0000000000000000, 7.0710678118654808 -7.0710678118654702, 0.0000000000000162 -10.0000000000000000, -7.0710678118654613 -7.0710678118654888, -10.0000000000000000 -0.0000000000000101, -7.0710678118654773 7.0710678118654746, -0.0000000000000285 10.0000000000000000, 7.0710678118654355 7.0710678118655146, 10.0000000000000000 0.0000000000000000))'</pre>
    <h3 class="fw5 f4">Bounding Box</h3>
    <div id="bounding-box"></div>
    <pre class="code overflow-scroll bg-near-white pa2">
>>> from shapely.wkt import loads
>>> loads('MULTIPOINT ((0 0), (0 0.5), (1.2 1), (5.5 6))').bounds
(0.0, 0.0, 5.5, 6.0)</pre>

    <h3 class="fw5 f4">Envelope</h3>
    <div id="envelope"></div>
    <pre class="code overflow-scroll bg-near-white pa2">
>>> from shapely.wkt import loads
>>> loads('MULTIPOINT ((0 0), (0 0.5), (1.2 1), (5.5 6))').envelope
'POLYGON ((0.0000000000000000 0.0000000000000000, 5.0000000000000000 0.0000000000000000, 5.0000000000000000 1.0000000000000000, 0.0000000000000000 1.0000000000000000, 0.0000000000000000 0.0000000000000000))'</pre>

    <h3 class="fw5 f4">Convex Hull</h3>
    <div id="convex-hull"></div>
    <pre class="code overflow-scroll bg-near-white pa2">
>>> from shapely.wkt import loads, dumps
>>> dumps(loads('MULTIPOINT ((0 0), (0 0.5), (1.2 1), (5.5 6), (7.7 5.5), (-1.0 10))').convex_hull)
'POLYGON ((0.0000000000000000 0.0000000000000000, -1.0000000000000000 10.0000000000000000, 7.7000000000000002 5.5000000000000000, 0.0000000000000000 0.0000000000000000))'</pre>

    <h3 class="fw5 f4">Union</h3>
    <div id="union"></div>
    <pre class="code overflow-scroll bg-near-white pa2">
>>> from shapely.geometry import Point
>>> from shapely.wkt import loads, dumps
>>> dumps(Point(0, 0).buffer(1.5).union(Point(0,1).buffer(1.5)))
'POLYGON ((1.5000000000000000 0.0000000000000000, 1.4927770900082953 -0.1470257104943408, 1.4711779206048456 -0.2926354830241921, 1.4354105035983133 -0.4354270158816932, 1.3858192987669304 -0.5740251485476341, 1.3228818965225329 -0.7070951052389958, 1.2472044184538182 -0.8333553495294026, 1.1595156800441062 -0.9515899262454675, 1.0606601717798223 -1.0606601717798205, 0.9515899262454695 -1.1595156800441044, 0.8333553495294048 -1.2472044184538169, 0.7070951052389979 -1.3228818965225317, 0.5740251485476362 -1.3858192987669296, 0.4354270158816953 -1.4354105035983127, 0.2926354830241945 -1.4711779206048452, 0.1470257104943431 -1.4927770900082951, 0.0000000000000024 -1.5000000000000000, -0.1470257104943383 -1.4927770900082955, -0.2926354830241897 -1.4711779206048461, -0.4354270158816907 -1.4354105035983142, -0.5740251485476318 -1.3858192987669313, -0.7070951052389935 -1.3228818965225342, -0.8333553495294006 -1.2472044184538196, -0.9515899262454659 -1.1595156800441073, -1.0606601717798192 -1.0606601717798234, -1.1595156800441035 -0.9515899262454702, -1.2472044184538165 -0.8333553495294055, -1.3228818965225315 -0.7070951052389985, -1.3858192987669293 -0.5740251485476366, -1.4354105035983127 -0.4354270158816954, -1.4711779206048452 -0.2926354830241942, -1.4927770900082953 -0.1470257104943426, -1.5000000000000000 -0.0000000000000015, -1.4927770900082953 0.1470257104943395, -1.4711779206048461 0.2926354830241912, -1.4354105035983136 0.4354270158816926, -1.4123059204384314 0.5000000000000000, -1.4354105035983127 0.5645729841183046, -1.4711779206048452 0.7073645169758058, -1.4927770900082953 0.8529742895056575, -1.5000000000000000 0.9999999999999984, -1.4927770900082953 1.1470257104943395, -1.4711779206048461 1.2926354830241913, -1.4354105035983136 1.4354270158816926, -1.3858192987669304 1.5740251485476340, -1.3228818965225329 1.7070951052389960, -1.2472044184538182 1.8333553495294028, -1.1595156800441058 1.9515899262454679, -1.0606601717798214 2.0606601717798210, -0.9515899262454689 2.1595156800441049, -0.8333553495294044 2.2472044184538169, -0.7070951052389980 2.3228818965225315, -0.5740251485476368 2.3858192987669291, -0.4354270158816962 2.4354105035983125, -0.2926354830241956 2.4711779206048448, -0.1470257104943447 2.4927770900082948, -0.0000000000000043 2.5000000000000000, 0.1470257104943362 2.4927770900082957, 0.2926354830241872 2.4711779206048465, 0.4354270158816880 2.4354105035983151, 0.5740251485476289 2.3858192987669327, 0.7070951052389904 2.3228818965225360, 0.8333553495293973 2.2472044184538218, 0.9515899262454622 2.1595156800441102, 1.0606601717798154 2.0606601717798272, 1.1595156800440998 1.9515899262454750, 1.2472044184538127 1.8333553495294110, 1.3228818965225280 1.7070951052390051, 1.3858192987669260 1.5740251485476442, 1.4354105035983102 1.4354270158817040, 1.4711779206048434 1.2926354830242035, 1.4927770900082942 1.1470257104943526, 1.5000000000000000 1.0000000000000124, 1.5000000000000000 1.0000000000000000, 1.4927770900082953 0.8529742895056592, 1.4711779206048456 0.7073645169758078, 1.4354105035983133 0.5645729841183068, 1.4123059204384314 0.5000000000000000, 1.4354105035983102 0.4354270158817039, 1.4711779206048434 0.2926354830242035, 1.4927770900082942 0.1470257104943527, 1.5000000000000000 0.0000000000000124, 1.5000000000000000 0.0000000000000000))'</pre>

    <h3 class="fw5 f4">Difference</h3>
    <div id="difference"></div>
    <pre class="code overflow-scroll bg-near-white pa2">
>>> from shapely.geometry import Point
>>> from shapely.wkt import loads, dumps
>>> dumps(Point(0, 0).buffer(1.5).difference(Point(0,1).buffer(1.5)))
'POLYGON ((1.5000000000000000 0.0000000000000000, 1.4927770900082953 -0.1470257104943408, 1.4711779206048456 -0.2926354830241921, 1.4354105035983133 -0.4354270158816932, 1.3858192987669304 -0.5740251485476341, 1.3228818965225329 -0.7070951052389958, 1.2472044184538182 -0.8333553495294026, 1.1595156800441062 -0.9515899262454675, 1.0606601717798223 -1.0606601717798205, 0.9515899262454695 -1.1595156800441044, 0.8333553495294048 -1.2472044184538169, 0.7070951052389979 -1.3228818965225317, 0.5740251485476362 -1.3858192987669296, 0.4354270158816953 -1.4354105035983127, 0.2926354830241945 -1.4711779206048452, 0.1470257104943431 -1.4927770900082951, 0.0000000000000024 -1.5000000000000000, -0.1470257104943383 -1.4927770900082955, -0.2926354830241897 -1.4711779206048461, -0.4354270158816907 -1.4354105035983142, -0.5740251485476318 -1.3858192987669313, -0.7070951052389935 -1.3228818965225342, -0.8333553495294006 -1.2472044184538196, -0.9515899262454659 -1.1595156800441073, -1.0606601717798192 -1.0606601717798234, -1.1595156800441035 -0.9515899262454702, -1.2472044184538165 -0.8333553495294055, -1.3228818965225315 -0.7070951052389985, -1.3858192987669293 -0.5740251485476366, -1.4354105035983127 -0.4354270158816954, -1.4711779206048452 -0.2926354830241942, -1.4927770900082953 -0.1470257104943426, -1.5000000000000000 -0.0000000000000015, -1.4927770900082953 0.1470257104943395, -1.4711779206048461 0.2926354830241912, -1.4354105035983136 0.4354270158816926, -1.4123059204384314 0.5000000000000000, -1.3858192987669293 0.4259748514523634, -1.3228818965225315 0.2929048947610015, -1.2472044184538165 0.1666446504705945, -1.1595156800441035 0.0484100737545298, -1.0606601717798192 -0.0606601717798234, -0.9515899262454659 -0.1595156800441073, -0.8333553495294006 -0.2472044184538196, -0.7070951052389935 -0.3228818965225342, -0.5740251485476318 -0.3858192987669313, -0.4354270158816907 -0.4354105035983142, -0.2926354830241897 -0.4711779206048461, -0.1470257104943383 -0.4927770900082955, 0.0000000000000024 -0.5000000000000000, 0.1470257104943431 -0.4927770900082951, 0.2926354830241945 -0.4711779206048452, 0.4354270158816953 -0.4354105035983127, 0.5740251485476362 -0.3858192987669296, 0.7070951052389979 -0.3228818965225317, 0.8333553495294048 -0.2472044184538169, 0.9515899262454695 -0.1595156800441044, 1.0606601717798223 -0.0606601717798205, 1.1595156800441062 0.0484100737545325, 1.2472044184538182 0.1666446504705974, 1.3228818965225329 0.2929048947610042, 1.3858192987669304 0.4259748514523659, 1.4123059204384314 0.5000000000000000, 1.4354105035983102 0.4354270158817039, 1.4711779206048434 0.2926354830242035, 1.4927770900082942 0.1470257104943527, 1.5000000000000000 0.0000000000000124, 1.5000000000000000 0.0000000000000000))'</pre>

    <h3 class="fw5 f4">Intersection</h3>
    <div id="intersection"></div>
    <pre class="code overflow-scroll bg-near-white pa2">
>>> from shapely.geometry import Point
>>> from shapely.wkt import loads, dumps
>>> dumps(Point(0, 0).buffer(1.5).intersection(Point(0,1).buffer(1.5)))
'POLYGON ((-1.4123059204384314 0.5000000000000000, -1.3858192987669304 0.5740251485476339, -1.3228818965225329 0.7070951052389959, -1.2472044184538182 0.8333553495294029, -1.1595156800441058 0.9515899262454679, -1.0606601717798214 1.0606601717798212, -0.9515899262454689 1.1595156800441049, -0.8333553495294044 1.2472044184538169, -0.7070951052389980 1.3228818965225317, -0.5740251485476368 1.3858192987669293, -0.4354270158816962 1.4354105035983125, -0.2926354830241956 1.4711779206048450, -0.1470257104943447 1.4927770900082948, -0.0000000000000043 1.5000000000000000, 0.1470257104943362 1.4927770900082957, 0.2926354830241872 1.4711779206048465, 0.4354270158816880 1.4354105035983149, 0.5740251485476289 1.3858192987669327, 0.7070951052389904 1.3228818965225357, 0.8333553495293973 1.2472044184538220, 0.9515899262454622 1.1595156800441102, 1.0606601717798154 1.0606601717798272, 1.1595156800440998 0.9515899262454750, 1.2472044184538127 0.8333553495294110, 1.3228818965225280 0.7070951052390051, 1.3858192987669260 0.5740251485476442, 1.4123059204384314 0.5000000000000000, 1.3858192987669304 0.4259748514523659, 1.3228818965225329 0.2929048947610042, 1.2472044184538182 0.1666446504705974, 1.1595156800441062 0.0484100737545325, 1.0606601717798223 -0.0606601717798205, 0.9515899262454695 -0.1595156800441044, 0.8333553495294048 -0.2472044184538169, 0.7070951052389979 -0.3228818965225317, 0.5740251485476362 -0.3858192987669296, 0.4354270158816953 -0.4354105035983127, 0.2926354830241945 -0.4711779206048452, 0.1470257104943431 -0.4927770900082951, 0.0000000000000024 -0.5000000000000000, -0.1470257104943383 -0.4927770900082955, -0.2926354830241897 -0.4711779206048461, -0.4354270158816907 -0.4354105035983142, -0.5740251485476318 -0.3858192987669313, -0.7070951052389935 -0.3228818965225342, -0.8333553495294006 -0.2472044184538196, -0.9515899262454659 -0.1595156800441073, -1.0606601717798192 -0.0606601717798234, -1.1595156800441035 0.0484100737545298, -1.2472044184538165 0.1666446504705945, -1.3228818965225315 0.2929048947610015, -1.3858192987669293 0.4259748514523634, -1.4123059204384314 0.5000000000000000))'</pre>
    <h3 class="fw5 f4">Removing borders from a shapefile</h3>
    <p class="measure-wide">
      You can combine Fiona and Shapely to do things like union a shapefile (or
      your homework). Be forewarned that sometimes Shapely might create invalid
      geometries and you'll end up with weird results. (Fun exercise, see if you
      can improve the speed of this code).
    </p>
    <pre class="code overflow-scroll bg-near-white pa2">
import fiona
import sys
from shapely.ops import unary_union
from shapely.geometry import shape, mapping
from functools import reduce

with fiona.drivers():
    with fiona.open(sys.argv[1]) as source:
        with fiona.open(sys.argv[2],
                        'w',
                        driver=source.driver,
                        crs=source.crs,
                        schema={'geometry': 'Polygon',
                                'properties': []}) as dest:
            polys = [shape(s['geometry']) for s in source]
            dest.write({
                'geometry': mapping(reduce(lambda x, y: x.union(y), polys)),
                'properties':{}
            })
    </pre>
    <h2 class="fw8 f3 pv4 ttu lh-title silver tracked">Spatial Queries</h2>
    <pre class="code overflow-scroll bg-near-white pa2">
>>> from shapely.geometry import Point
>>> from shapely.wkt import loads
>>> Point(0, 0).buffer(1.5).intersects(Point(0, 1).buffer(1.5))
True
>>> loads('POLYGON ((0 0, 0 1, 1 1, 1 0, 0 0))').touches(loads('POLYGON ((1 0, 1 1, 2 1, 2 0, 1 0))'))
True
>>> loads('POLYGON ((0 0, 0 1, 1 1, 1 0, 0 0))').intersects(loads('POLYGON ((1 0, 1 1, 2 1, 2 0, 1 0))'))
True
>>> loads('POLYGON ((0 0, 0 1, 1 1, 1 0, 0 0))').overlaps(loads('POLYGON ((1 0, 1 1, 2 1, 2 0, 1 0))'))
False
>>> loads('POINT (0.5 0.5)').within(loads('POLYGON ((0 0, 0 1, 1 1, 1 0, 0 0))'))
True</pre>

    <h2 class="fw8 f3 pv4 ttu lh-title silver tracked">Joining Shapefiles with Census Data</h2>
    <p class="measure-wide">
      There are two ways to do this in the command line using
      <a href="http://www.gdal.org/ogr_sql.html">OGR</a>:
      <pre class="code overflow-scroll bg-near-white pa2">
ogr2ogr joined.shp tracts.shp -sql "select *, cast(int_field as int) from tracts left join 'data.csv' data on tracts.geoid = data.geoid"</pre>
      Or using QGIS. You also can read the csv in Python and join it on a Fiona
      dataset.
    </p>
    <h2 class="fw8 f3 pv4 ttu lh-title silver tracked">Homework</h2>
    <p class="measure-wide">
      Your homework this week has three parts:
      <ol>
        <li class="measure-wide pv1" >
          1. Contact the county assessor for your county to see if they
          have a dataset of home foreclosures since 2009. If not see if they know
          where to get one. If that fails just hold on to proof you did it.
          (We'll need this next week.)
        </li>
        <li class="measure-wide pv1">
          2. Join your counties tracts on the most recent census data. Filter the
          census tracts file to only contain the tracts for your county -- hint
          look at the COUNTYFP field in the tract shapefile. Make a cloropleth of
          population for one race and email me an image of your chloropleth.
        </li>
        <li class="measure-wide pv1">
          <p>
          3. Create a dot density map of the population of one race using
          Fiona and Shapely. You must design a function that has this signature:
          <pre  class="code overflow-scroll bg-near-white pa2">
def dots(shape, population):
    # your code here</pre>
          That is it takes one polygon and a population number and creates a
          Multipoint geometry of randomly placed dots that all fall within
          the passed in polygon. The number of dots in Multipoint should
          be equal to the population argument. You'll need to send your dots
          function to me before class. If you get stuck Tom MacWright has a
          <a href="http://www.macwright.org/2012/10/31/gis-with-python-shapely-fiona.html">
            tutorial
          </a> on how to use Shapely and Fiona together.
          </p>
        </li>
      </ol>
    </p>
    <script>
     document.querySelectorAll("pre").forEach(function(it){
       var lines = it.innerText.split("\n");
       var wkt = lines.pop();
       if(wkt[0] != "'") return;
       wkt = wkt.replace(/'/g, "");
       var w = new Wkt.Wkt(wkt);
       var canvas = it.previousElementSibling;
       var el = d3.select("#" + canvas.id)
                  .append("svg")
                  .style("width", 400)
                  .style("height", 400);
       var projection = d3.geoProjection(function(x, y){ return [x, y]; })
                          .scale(800)
                          .translate([200, 200]);
       var path = d3.geoPath()
                    .projection(projection);
       el.append('path')
         .datum(w.toJson())
         .attr("d", path);
     });
    </script>
  </body>
</html>
