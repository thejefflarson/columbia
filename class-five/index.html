<html>
  <head>
    <title>Class Five | Columbia GIS</title>
    <script src="../javascripts/d3.js"></script>
    <script src="../javascripts/topojson.min.js"></script>
  </head>
  <body>
    <h2>Policy Note</h2>
    <p>
      From here on out homework is due whenever you can finish it.
      I've updated the syllabus to reflect where I think you guys
      want to go, the biggest change is I've dropped PostGIS.
      Please send me an email or on slack if you have comments.
    </p>
    <p>
      Also no homework this week to allow everyone to catch up on
      the most recent assignments. I'll send each of you an email
      on where you are homework-wise.
    </p>
    <h2>Fundamentals of SVG / Canvas</h2>
    <div>
    <div>
      <canvas id="canvas-demo"></canvas>
      <pre>
var canvas = document.getElementById("canvas-demo");
canvas.width = 400;
canvas.height = 400;
var ctx = canvas.getContext("2d");

var loop = function() {
  requestAnimationFrame(function() {
    var time = (new Date()).getTime() / 1000;
    var coords = [[-50, -50], [-50, 50], [50, 50], [50, -50]];
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
    coords.forEach(function(pt, i) {
      var x = Math.cos(time) * pt[0] +
              Math.sin(time) * pt[1] + 200;
      var y = -1 * Math.sin(time) * pt[0] +
              Math.cos(time) * pt[1] + 200;
      if(i === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    });
    ctx.closePath();
    ctx.strokeStyle = "#666";
    ctx.lineWidth = 5;
    ctx.stroke();
    loop();
  });
};

loop();</pre>
    <script>
     (function(){
       var canvas = document.getElementById("canvas-demo");
       canvas.width = 400;
       canvas.height = 400;
       var ctx = canvas.getContext("2d");

       var loop = function() {
         requestAnimationFrame(function() {
           var time = (new Date()).getTime() / 1000;
           var coords = [[-50, -50], [-50, 50], [50, 50], [50, -50]];
           ctx.clearRect(0, 0, canvas.width, canvas.height);
           ctx.beginPath();
           coords.forEach(function(pt, i) {
             var x = Math.cos(time) * pt[0] +
                     Math.sin(time) * pt[1] + 200;
             var y = -1 * Math.sin(time) * pt[0] +
                     Math.cos(time) * pt[1] + 200;
             if(i === 0) {
               ctx.moveTo(x, y);
             } else {
               ctx.lineTo(x, y);
             }
           });
           ctx.closePath();
           ctx.strokeStyle = "#666";
           ctx.lineWidth = 5;
           ctx.stroke();
           loop();
         });
       };
       loop();
     })();
    </script>
    <div>
    <svg id="svg-demo" xmlns="http://www.w3.org/2000/svg"></svg>
    <style>
     #svg-demo {

     }
     .spinning {
       fill: #666;
       animation: spin 4s linear infinite;
       transform-origin: 50% 50%;
     }
     @keyframes spin {
       100% {
         transform: rotate(360deg);
       }
     }
    </style>
    <script>
     (function(){
       var svg = document.getElementById("svg-demo");
       svg.setAttribute('width', 400);
       svg.setAttribute('height', 400);
       var rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
       rect.setAttribute('x', 150);
       rect.setAttribute('y', 150);
       rect.setAttribute('width', 100);
       rect.setAttribute('height', 100);
       rect.setAttribute('class', 'spinning');
       svg.appendChild(rect);
      })();
    </script>
    </div>
    </div>
    <h2>Translating Shapefiles to GeoJSON</h2>
    <p>
      The defacto standard for working with geodata on the web is GeoJSON.
      It's easy to translate a shapefile to json using ogr2ogr.
    </p>
    <pre>
ogr2ogr out.json src.shp -f GeoJSON -simplify 10.0 -t_srs EPSG:3857</pre>
    <p>
      Which is essentially the same thing as the following in python:
    </p>
    <pre>
import fiona
import sys
import pyproj
from shapely.geometry import shape, mapping
from shapely.ops import transform

def project(s_srs, t_srs, x, y, z=None):
    return pyproj.transform(s_srs, t_srs, x, y, z)

with fiona.drivers():
    with fiona.open(sys.argv[1]) as source:
        with fiona.open(sys.argv[2],
                        'w',
                        driver='GeoJSON',
                        crs=source.crs,
                        schema=source.schema) as dest:
            s_srs = pyproj.Proj(**source.crs)
            t_srs = pyproj.Proj(init='epsg:3857')
            for s in source:
                geom = shape(s['geometry'])
                projected = transform(lambda x, y, z=None: pyproj.transform(s_srs, t_srs, x, y, z), geom)
                simplified = projected.simplify(20.0)
                dest.write({
                    'geometry': mapping(simplified),
                    'properties': s['properties']
                })
    </pre>
    <p>
      We'll need npm and node to install topojson. On OS X you can run:
    </p>
    <pre>
brew install node</pre>
    <p>
      On windows you can download the packages from the
      <a href="https://nodejs.org/en/download/">Nodejs</a> website.
    </p>
    <p>
      Once you have node installed you can run topojson:
    <pre>
npm install -g topojson
topojson source.shp -o out.topojson
    </pre>
    <h2>Using JavaScript to make a Map</h2>
    <div id="canvas-map" class="run">
    </div>
    <script>
     var el = document.getElementById("canvas-map");
     var canvas = document.createElement("canvas");
     el.appendChild(canvas);
     canvas.width = 500;
     canvas.height = 500;
     var ctx = canvas.getContext("2d");
     // We're using fetch here which isn't wildly supported natively
     // but there's a polyfill here: https://github.com/github/fetch
     fetch("./brooklyn-demos.json")
       .then(function(response) {
         if (response.status >= 200 && response.status < 300) {
           return response.json();
         } else {
           throw new Error("Couldn't load json.");
         }
       })
       .then(draw)
       .catch(function(error) {
         console.log(error);
       });

     function draw(json) {
       var bounds = [Infinity, Infinity, -Infinity, -Infinity];
       json.features.forEach(function(feature){
         if(feature.geometry.type != "Polygon")
           throw new Error("I can only handle Polygon's.");
         feature.geometry.coordinates.forEach(function(ring) {
           ring.forEach(function(point) {
             bounds[0] = Math.min(point[0], bounds[0]);
             bounds[1] = Math.min(point[1], bounds[1]);
             bounds[2] = Math.max(point[0], bounds[2]);
             bounds[3] = Math.max(point[1], bounds[3]);
           });
         });
       });

       var project = function(pt) {
         var lng = pt[0];
         var lat = pt[1];

         var scale = canvas.width / (bounds[3] - bounds[1]);
         var x = (lng - bounds[0]) * scale;
         var y = (lat - bounds[1]) * scale * -1 + canvas.height;

         return [x, y];
       };

       json.features.forEach(function(feature){
         ctx.save();
         ctx.beginPath();
         feature.geometry.coordinates.forEach(function(ring) {
           ring.forEach(function(pt, idx){
             pt = project(pt);
             if(idx == 0) ctx.moveTo(pt[0], pt[1]);
             ctx.lineTo(pt[0], pt[1]);
           });
         });
         ctx.closePath();
         ctx.fillStyle = "rgba(64, 135, 70," + (feature.properties.p_black / 100.0) + ")";
         ctx.strokeStyle = "#666";
         ctx.lineWidth = 0.5;
         ctx.fill();
         ctx.stroke();
         ctx.restore();
       });
     };
    </script>
    <h2>Using d3 to make a Map</h2>
    <p>
      Mike Bostock has a great tutorial on using d3 for
      <a href="https://bost.ocks.org/mike/map/">mapping</a>, it's
      written in an old version of d3, but only the names of the
      functions have changed. For example d3.geo.transverseMercator
      is now d3.geoTransversemercator.
    </p>
    <svg id="d3">
    </svg>

    <style>
     .border {
       fill: none;
       stroke: #666;
       stroke-linejoin: round;
     }
    </style>
    <script>
     d3.json("./brooklyn-demos.topojson", function(error, data) {
       if(error) throw error;

       var d3map = d3.select("#d3");
       d3map.style("width", 400)
            .style("height", 400);

       var group = d3map.append("g")
                        .attr("id", "blocks");
       var tracts = topojson.feature(data, data.objects["brooklyn-demos"]);
       var projection = d3.geoMercator()
                          .fitExtent([[0, 0], [400, 400]],
                                     tracts);

       var path = d3.geoPath()
                    .projection(projection);
       // polygons
       group.selectAll("path")
            .data(tracts.features)
            .enter()
            .append("path")
            .attr("d", path)
            .attr("fill", function(it) {
              return "rgba(64, 135, 70, " + (it.properties.p_black / 100.0) + ")";
             });
       group.append("path")
            .datum(topojson.mesh(data, data.objects["brooklyn-demos"]))
            .attr("d", path)
            .attr("class", 'border');
     });
    </script>
    <h2>Projections in d3</h2>
    <svg id="projections"></svg>
    <script>
     d3.json("../data/world.topojson", function(e, world) {
       if(e) throw e;
       var map = d3.select("#projections");
       map.attr('width', 400)
          .attr('height', 400);
       var p = map.append("path").attr("class", "border");
       var world = topojson.mesh(world, world.objects.land);
       setInterval(function() {
         var proj = [
           d3.geoAlbers,
           d3.geoMercator,
           d3.geoGnomonic,
           d3.geoOrthographic,
           d3.geoTransverseMercator
         ][Math.random() * 5 | 0];


         var projection = proj()
                            .fitExtent([[0,0], [400,[400]]], world);

         var path = d3.geoPath()
                      .projection(projection);

         p.datum(world)
          .attr("d", path)
          .attr("class", "border");
       }, 1000);
     });
    </script>
    <!-- finish to here tomorrow -->
    <h2>Using Proj4 to project points with d3</h2>
    <div class="run">
      <pre>
      </pre>
    </div>
    <h2>Implementing Hovers</h2>
    <div class="run">
      <pre>
      </pre>
    </div>
  </body>
</html>
